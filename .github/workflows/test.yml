name: Test

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env: # Set environment variables for every job and step in this workflow
  CLICOLOR: "1" # Enable colors for *NIX commands
  PY_COLORS: "1" # Enable colors for Python-based utilities
  FORCE_COLOR: "1" # Force colors in the terminal
  is-pull-request: ${{ github.event_name == 'pull_request' }}
  is-merge: ${{ github.event_name == 'push' && github.ref_name == 'master' }}

permissions:
  # Required by nrwl/nx-set-shas
  actions: read
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # Required by nrwl/nx-set-shas
          fetch-depth: 0

      - name: "Derive appropriate SHAs for master and head for `nx affected` commands"
        uses: nrwl/nx-set-shas@v3
        with:
          main-branch-name: master

      - name: Setup node
        uses: ./.github/actions/node

      - name: Build feature
        if: ${{ env.is-pull-request == 'true' }}
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: yarn nx affected:build --exclude @kiwicom/orbit.kiwi

      - name: Build master
        if: ${{ env.is-merge == 'true' }}
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: yarn nx run-many -t build --all --parallel

      - name: "Types all"
        if: ${{ env.is-merge == 'true' }}
        run: yarn nx run-many -t check:types --exclude @kiwicom/orbit.kiwi

      - name: "Types affected"
        if: ${{ env.is-pull-request == 'true' }}
        run: yarn check:types:affected

      - name: "Test affected"
        if: ${{ env.is-pull-request == 'true' }}
        run: yarn test:affected

      - name: "Test all"
        if: ${{ env.is-merge == 'true' }}
        run: yarn test:all

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # Required by nrwl/nx-set-shas
          fetch-depth: 0

      - name: "Derive appropriate SHAs for master and head for `nx affected` commands"
        uses: nrwl/nx-set-shas@v3
        with:
          main-branch-name: master

      - name: Setup node
        uses: ./.github/actions/node

      - name: "Lint affected"
        if: ${{ env.is-pull-request == 'true' }}
        run: yarn check:lint:affected

      - name: "Lint all"
        if: ${{ env.is-merge == 'true' }}
        run: yarn check:lint:all

  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Node
        uses: ./.github/actions/node

      - name: Restore Gatsby cache
        uses: actions/cache@v3
        with:
          # Required by nrwl/nx-set-shas
          fetch-depth: 0
          path: |
            docs/.cache
            docs/public
          key: gatsby-${{ github.ref}}-${{ hashFiles('docs/gatsby-config.js', 'docs/gatsby-node.js') }}
          restore-keys: |
            gatsby-${{ github.ref}}-
            gatsby-

      - name: Build
        env:
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES: true
          NODE_OPTIONS: "--max_old_space_size=4096"

        run: yarn nx run @kiwicom/orbit.kiwi:build

      - name: Check links
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: yarn check:links

      - name: Check types
        run: yarn nx run @kiwicom/orbit.kiwi:check:types

  cypress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # Requrired by nrwl/nx-set-shas
          fetch-depth: 0

      - name: Node
        uses: ./.github/actions/node

      - name: Build
        run: yarn nx run @kiwicom/orbit-components:build

      - name: Cypress
        uses: cypress-io/github-action@v5
        with:
          install: false
          working-directory: packages/orbit-components
          start: yarn cy:dev
